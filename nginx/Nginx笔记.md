* ?????/usr/local/Cellar/nginx/1.19.10
* ?????/usr/local/etc/nginx/nginx.conf
# Ngnix??
* ??
    * ????
    * ????
    * ???????
    * FastCGI
    * SSL?TLS
* ??
    * ???+????
    * epoll?? poll select
* ????
    * ???????
    * ??????

# ?????Nginx
* ????HTTP?????????????
* ????? ??????

# Nginx???PHP??
* https://zhuanlan.zhihu.com/p/33725635

# Nginx?Apache?Tomcat???
* ?? https://www.zhihu.com/question/32212996/answer/685297650
* ???
    * ????? ????????????
* Apache ????
    * ?????
    * ??????????????
    * ???????
    * select ????
    * ?????????? ?????????
* Nginx ????
    * ???HTTP ????? web???
    * epoll?????
    * ????????????????????????
* Tomcat ????
    * ????????
    * ?Apache??? ??????
    * ??servlet?jsp???

# ?????PHP
* ????
    * -c ?????? ?????????/usr/local/etc/nginx/nginx.conf
    * -t ??? ??????
    * -v Nginx??
    * -V ??Nginx?????????????
* ??
    * nginx ??
    * ??Nginx
        * ps -ef |grep nginx ??Nginx???
            * ps ??????
            * -A ????
            * -w ??????
            * -au ??????
            * -aux ???????
            * **ps -ef | grep ????? ????????** grep???????
        * kill -QUIT  nginx ????Nginx(????????)
        * kill -TERM nginx???? ????
        * kill -9 nginx???? ????
    * ??Nginx
        * ????? ???? ??Nginx
        * ?????? ????? kill -HUP pid
        * ???? kill -USR2 pid(root id) ???????? kill -WINCH pid ????Nginx

# ??Nginx
* ??hash???
    * server_names_hash_max_size ??hash???
    * server_names_hash_bucket_size hash???
* **??????**
    * use
        * --with-select_module ??
        * --without-select_module ??
        * --with-poll_module ?????epoll????
        * --without-poll_module
        * kqueue
        * epoll linux??2.6??
        * rtsig ????
        * /dev/poll
        * eventport
* ??????
* ????????

# ??Nginx
* ??debug --with-debug
* debug_connection????

# location
* ????
    * ~ ???????????????????
    * ~* ?????????????????
    * ^~ ????????????????????????????????????????
    * = ??????????
    * "@"??????? location???????????? error_page, try_files
* ?????
    * =?????
    * ?????
    * ????
* ????$query_string?????? ??if??
* **url???/ ?????????**

# upstream
* ???????
* nginx??????????????????
* **??????????????????????**
* ??
    * weight=number ??
    * max_fails=number ??????
    * fail_timeout ??????
    * backup ??
    * down ???
* **??IP??hash?????????????**
* keepalive 32 ??worker?????????????????


# rewrite
* ????
    * 1.??server??rewrite??(???????server????{}????????xx???)
    * 2.??location??
    * 3.?????location??rewrite??
* break
* if
* return ?????
* rewrite
    * last ???????
    * break ??????
    * redirect ??302 ?????
    * permant ??301 ?????
* rewrite_log on|off;
* set variable value;
* uninitialized_variable_warn on | off;

```
if ($http_user_agent ~ MSIE) {
     rewrite ^(.*)$ /msie/$1 break;
 }
 
 if ($http_cookie ~* "id=([^;]+)(?:;|$)") {
     set $id $1;
 }
 
 if ($request_method = POST) {
     return 405;
 }
 
 if ($slow) {
     limit_rate 10k;
 }
 
 if ($invalid_referer) {
     return 403;
 }
```
```
 server {
     ...
     rewrite ^(/download/.*)/media/(.*)..*$ $1/mp3/$2.mp3 last;
     rewrite ^(/download/.*)/audio/(.*)..*$ $1/mp3/$2.ra last;
     return 403;
     ...
 }
```

# ????
* ???? proxy_pass
* ???? proxy_pass(????) fastcgi_pass(fastcgi??)
    * ??????????????????????
    * ??????


# ????
* ??web??+??web???
* web??
    * ?????? ?????????
    * ???proxy??
* proxy
    * proxy_pass
    * proxy_cache
* ??
    * proxy_cache ?????????
    * fastcgi_cache FastCGI??????

```
#cache begin
proxy_buffering on;
proxy_cache_valid any 10m;
proxy_cache_path /data/cache levels=1:2 keys_zone=my-cache:8m max_size=1000m inactive=600m;
proxy_temp_path /data/temp;
proxy_buffer_size 4k;
proxy_buffers 100 8k;
#cache end
```
```
location / {
proxy_pass http://apachephp;
proxy_cache my-cache;
proxy_cache_valid 200;

#Proxy Settings
proxy_redirect off;
proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
proxy_max_temp_file_size 0;
proxy_connect_timeout 90;
proxy_send_timeout 90;
proxy_read_timeout 90;
proxy_buffer_size 4k;
proxy_buffers 4 32k;
proxy_busy_buffers_size 64k;
proxy_temp_file_write_size 64k;
##End Proxy Settings
}
```

# ??IP
* ??ip???????
    * ??blockip.conf ??deny 165.91.122.67;
    * include blockip.conf; ??
    * deny IP;  ????IP
    * allow IP; ????IP
    * deny all; ????IP
    * allow all;  ????IP
    * deny 123.0.0.0/8 ??IP?
* iptable

# nginx "403 Forbidden" ??
* ?????
    * ???????
    * ????????

# nginx "404" ??
* ?????
    * ????? ????
    * root?location?->server->document_root
    * fastCGI??????
* ????
    * nginx?????????????????404??

?????404
```
location ~ .php$ {
 try_files $uri =404;
 fastcgi_pass 127.0.0.1:9000;
 fastcgi_index index.php;
 fastcgi_param SCRIPT_FILENAME 
}
```

# nginx "502" ?? ????
* ??????????php-fpm????? ????
* ????
* ????
    * php-fpm?????? ?????
    * ????linux???????? ???????
    ```
    echo 'ulimit -HSn 65536' >> /etc/profile
    echo 'ulimit -HSn 65536' >> /etc/rc.local
    source /etc/profile
    ```
    * ???????? ??????
    ```
    request_terminate_timeout = 10s
    ```
    * ???????
    ```
    proxy_buffer_size 64k;
    proxy_buffers  512k;
    proxy_busy_buffers_size 128k;
    ```
    * ???????????????????????
    ```
    request_terminate_timeout=0;
    ```

# ??
* nginx????????????????????????IP??????????http???????
* ???get?? ??post???????
* Echo module echo_read_request_body + $request_body
* --add-module=/tmp/echo-nginx-module
* echo_read_request_body; ?????